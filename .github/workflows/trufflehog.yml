name: Scan All Repos with TruffleHog

on:
  workflow_dispatch:

jobs:
  scan-all:
    runs-on: ubuntu-latest

    steps:
      - name: Install TruffleHog and GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
          pip install trufflehog

      - name: Fetch and scan all repositories (excluding forks)
        env:
          USERNAME: ${{ github.repository_owner }}  # This should be your GitHub username (e.g., zaorinu)
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir results
          echo "" > results/failures.txt
          gh repo list "$USERNAME" --limit 100 --json name,sshUrl,isFork -q '.[] | select(.isFork == false) | "\(.name) \(.sshUrl)"' > repos.txt

          while read -r name url; do
            echo "ðŸ” Cloning $name"
            # Convert SSH URL to HTTPS URL
            HTTPS_URL=$(echo "$url" | sed 's/git@github.com:/https:\/\/github.com\//')
            git clone "$HTTPS_URL" || { echo "Error cloning $name" >> ../results/failures.txt; continue; }
            cd "$name"
            echo "ðŸš¨ Scanning $name"

            # Run TruffleHog scan with error handling
            trufflehog --regex --entropy=True --json . > result.json || { echo "Error scanning $name" >> ../results/failures.txt; cd ..; rm -rf "$name"; continue; }

            # Process TruffleHog result and check if any secrets were found
            if [ -s result.json ]; then
              echo "$name:" >> ../results/failures.txt
              jq -r '.results[] | "  - \(.file) \(.line)"' result.json >> ../results/failures.txt
              echo "" >> ../results/failures.txt
            fi

            cd ..
            rm -rf "$name"
          done < repos.txt

      - name: Show summary
        run: |
          echo "=== Repositories with potential secrets ==="
          cat results/failures.txt || echo "âœ… All clean!"

      - name: Create issue if any repo failed
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -s results/failures.txt ]; then
            TITLE="TruffleHog Secrets Report - $(date -u +'%Y-%m-%d %H:%M UTC')"
            BODY="Secrets were detected in the following repositories and files:\n\n$(cat results/failures.txt)\n\nPlease investigate.\n\n_This issue was created automatically._"

            # Define the repository name to create the issue in
            REPO_NAME="user-actions"  # Set to your repository name
            USERNAME="zaorinu"  # Ensure your username is explicitly set (e.g., zaorinu)

            # Create the issue in the specified repository, with the full repository name
            gh issue create --title "$TITLE" --body "$BODY" --label "trufflehog" --repo "$USERNAME/$REPO_NAME"
          fi
