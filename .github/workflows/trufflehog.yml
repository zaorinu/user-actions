name: TruffleHog Scan

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # Daily at 02:00 UTC

jobs:
  checkout:
    name: Checkout Repository
    runs-on: ubuntu-latest
    outputs:
      repo-path: ${{ steps.setpath.outputs.path }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Output Path
        id: setpath
        run: echo "path=$(pwd)" >> "$GITHUB_OUTPUT"

  close_old_issues:
    name: Close Old TruffleHog Issues
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Close Issues with 'trufflehog' Label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issues=$(gh issue list --label "trufflehog" --state open --json number --jq '.[].number')
          for issue in $issues; do
            gh issue close $issue --comment "Automatically closed before new TruffleHog scan."
          done

  scan:
    name: Run TruffleHog Scan
    runs-on: ubuntu-latest
    needs: checkout
    outputs:
      found_secrets: ${{ steps.check.outputs.found_secrets }}
    steps:
      - name: Run TruffleHog Docker Scan
        run: |
          docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest github --org=zaorinu --only-verified > trufflehog-output.txt

      - name: Check Scan Results
        id: check
        run: |
          if grep -q "Found unverified result\|Found verified result" trufflehog-output.txt; then
            echo "found_secrets=true" >> "$GITHUB_OUTPUT"
          else
            echo "found_secrets=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Save Scan Output
        if: always()
        run: cp trufflehog-output.txt $GITHUB_WORKSPACE/trufflehog-output.txt

  create_issue:
    name: Create GitHub Issue if Secrets Found
    runs-on: ubuntu-latest
    needs: scan
    if: needs.scan.outputs.found_secrets == 'true'
    steps:
      - name: Download Scan Output
        run: echo "No artifacts to download, using workspace copy"

      - name: Create Issue on GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "TruffleHog Report - $(date -u +'%Y-%m-%d %H:%M UTC')" \
            --body "$(cat $GITHUB_WORKSPACE/trufflehog-output.txt)" \
            --label "trufflehog" \
            --repo zaorinu/user-actions